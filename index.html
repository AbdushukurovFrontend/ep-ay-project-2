<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School Project</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <style>
      ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      td {
        vertical-align: middle;
      }

      #search {
        outline: none;
        padding: 10px;
        border-radius: 7px;
        border: 1px solid rgba(128, 128, 128, 0.619);
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse d-flex justify-content-between"
          id="navbarNav"
        >
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" href="./index.html">Students</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Classes</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="./teacher.html">Teachers</a>
            </li>
          </ul>
          <input id="search" type="text" placeholder="enter your text" />
        </div>
      </div>
    </nav>

    <section class="container py-3">
      <div class="d-flex justify-content-between align-items-center">
        <h2>Students</h2>
        <button class="btn" onclick="openStudentModal()">+</button>
      </div>
      <table class="table" id="students-table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Photo</th>
            <th scope="col">Fullname</th>
            <th scope="col">Class</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <div
      class="modal fade"
      id="infoModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Info</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">...</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Student add/edit modal -->
    <div
      class="modal fade"
      id="studentModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Student</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="photo" class="form-label">Photo</label>
                <input class="form-control" id="photo" />
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input class="form-control" id="name" />
              </div>
              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input class="form-control" id="lastName" />
              </div>
              <div class="mb-3">
                <label for="class" class="form-label">Class</label>
                <select class="form-select" id="class">
                  <option value="9A">9 "A"</option>
                  <option value="9B">9 "B"</option>
                  <option value="9B">G "16"</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-select" id="gender">
                  <option value="male">Boy</option>
                  <option value="female">Girl</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveStudent()"
            >
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- teacher modal________ -->
    <div
      class="modal fade"
      id="teacherModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body teacherBody">...</div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- edit modal____________ -->
    <div
      class="modal fade"
      id="editmodal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form>
              <div class="mb-3">
                <label for="photo" class="form-label">Photo</label>
                <input class="form-control" id="photo1" />
              </div>
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input class="form-control" id="name1" />
              </div>
              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input class="form-control" id="lastName1" />
              </div>
              <div class="mb-3">
                <label for="class" class="form-label">Class</label>
                <select class="form-select" id="class1">
                  <option value="9A">9 "A"</option>
                  <option value="9B">9 "B"</option>
                  <option value="G16">G "16"</option>
                </select>
              </div>
              <div class="mb-3">
                <label for="gender" class="form-label">Gender</label>
                <select class="form-select" id="gender1">
                  <option value="male">Boy</option>
                  <option value="female">Girl</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="edit2button()"
            >
              Save changes
            </button>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.8/axios.min.js"
      integrity="sha512-PJa3oQSLWRB7wHZ7GQ/g+qyv6r4mbuhmiDb8BjSFZ8NZ2a42oTtAq5n0ucWAwcQDlikAtkub+tPVCw4np27WCg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>

    <script>
      const search = document.getElementById("search");
      let lastId = 0;
      const editmodal = new bootstrap.Modal("#editmodal", {
        keyboard: false,
      });
      const teacherModal = new bootstrap.Modal("#teacherModal", {
        keyboard: false,
      });
      const infoModal = new bootstrap.Modal("#infoModal", {
        keyboard: false,
      });

      const infoModalModalTitle = document.querySelector(
        "#infoModal .modal-title"
      );
      const infoModalModalBody = document.querySelector(
        "#infoModal .modal-body"
      );

      const studentModal = new bootstrap.Modal("#studentModal", {
        keyboard: false,
      });

      const teacherBody = document.querySelector(".teacherBody");
      const studentsTableBody = document.querySelector("#students-table tbody");

      const spinHtml = `<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>`;
      const errorHtml = `<div class="alert alert-danger" role="alert">Xatolik sodir boldi</div>`;

      const main = () => {
        studentsTableBody.innerHTML = `<tr><td colspan="5" class="text-center">${spinHtml}</td></tr>`;

        axios
          .get("https://a6d284e69c9e5cfd.mokky.dev/students")
          .then((res) => {
            studentsTableBody.innerHTML = "";
            res.data.forEach((item, index) => {
              studentsTableBody.innerHTML += `
              <tr>
                <td>${index + 1}</td>
                <td><img src="${
                  item.studentFoto
                }" width="40" height="40" class="object-fit-cover rounded"></td>
                <td>${item.name || ""} ${item.lastName || ""}</td>
                <td>${item.class}</td>
                <td>
                  <div class="dropdown">
                    <button class=" border-0 bg-transparent" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="showStudentInfo(${
                        item.id
                      })">Info</a></li>
                      <li><a class="dropdown-item" href="#">Class</a></li>
                      <li><a class="dropdown-item" href="#" onclick="openTeacherModal()">Teacher</a></li>
                      <li><a class="dropdown-item" href="#" onclick="openEditModal(${
                        item.id
                      })">Edit</a></li>
                      <li><a class="dropdown-item" href="#" onclick="removeStudent(${
                        item.id
                      })">Remove</a></li>
                    </ul>
                  </div>
                </td>
              </tr>
            `;
            });
          })
          .catch((error) => {
            studentsTableBody.innerHTML = `<tr><td colspan="5">${errorHtml}</td></tr>`;
          });
      };

      main();

      const showStudentInfo = (id) => {
        infoModalModalTitle.innerHTML = "Student Info";
        infoModalModalBody.innerHTML = spinHtml;

        axios
          .get(`https://a6d284e69c9e5cfd.mokky.dev/students/${id}`)
          .then((res) => {
            const student = res.data;
            infoModalModalBody.innerHTML = `
            <div class="row">
              <div class="col-md-4 mb-4">
                <img src="${
                  student.studentFoto
                }" class="object-fit-cover rounded w-100">
              </div>
              <div class="col-md-8">
                <p>ID: ${student.id}</p>
                <p class="fw-bold">Name: ${student.name || ""} ${
              student.lastName || ""
            }</p>
                <p>Class: ${student.class}</p>
                <p>Gender: ${student.gender === "male" ? "Boy" : "Girl"}</p>
              </div>
            </div>
          `;
          })
          .catch((error) => {
            infoModalModalBody.innerHTML = `<div class="alert alert-danger" role="alert">Xatolik sodir boldi</div>`;
          });

        infoModal.show();
      };

      const openStudentModal = () => {
        studentModal.show();
      };

      const saveStudent = () => {
        const data = {
          name: document.querySelector("#name").value,
          lastName: document.querySelector("#lastName").value,
          class: document.querySelector("#class").value,
          gender: document.querySelector("#gender").value,
          studentFoto: document.querySelector("#photo").value,
        };

        if (Object.values(data).filter((item) => item == "").length > 0) {
          Toastify({
            text: "Malumotlarni to'liq kiriting",
            duration: 2000,
            style: {
              background: "orange",
            },
          }).showToast();
          return;
        }

        axios
          .post("https://a6d284e69c9e5cfd.mokky.dev/students", data)
          .then((res) => {
            Toastify({
              text: "Muvaffaqiyatli saqlandi",
              duration: 2000,
            }).showToast();
            document.querySelector("#name").value = "";
            document.querySelector("#lastName").value = "";
            document.querySelector("#class").value = "";
            document.querySelector("#gender").value = "";
            document.querySelector("#photo").value = "";
            studentModal.hide();
            main();
          })
          .catch((error) => {
            Toastify({
              text: "Xatolik sodir boldi",
              duration: 2000,
              style: {
                background: "red",
              },
            }).showToast();
          });
      };

      const removeStudent = (id) => {
        axios
          .delete(`https://a6d284e69c9e5cfd.mokky.dev/students/${id}`)
          .then((res) => {
            Toastify({
              text: "O'chirildi",
              duration: 2000,
            }).showToast();
            main();
          })
          .catch((error) => {
            Toastify({
              text: "Xatolik sodir boldi",
              duration: 2000,
              style: {
                background: "red",
              },
            }).showToast();
          });
      };

      const openTeacherModal = () => {
        teacherModal.show();
        axios
          .get("https://a6d284e69c9e5cfd.mokky.dev/teachers")
          .then((response) => {
            const teachers = response.data;
            let teacherHtml = "";

            teachers.forEach((teacher) => {
              teacherHtml += `
            <div class="row mb-3">
              <div class="col-2">
                <img src="${teacher.img}" class="w-100 object-fit-cover rounded" alt=""/>
              </div>
              <div class="col-6">
                <p class="fw-bold">name:${teacher.name} ${teacher.lastName}</p>
                <p class="">address:${teacher.address}</p>
                <p>expage:${teacher.expage}</p>
                <p>salary:${teacher.salary}</p>
                <p>age:${teacher.age}</p>
              </div>
            </div>
          `;
            });

            teacherBody.innerHTML = teacherHtml;
          })
          .catch((error) => {
            console.error("Xatolik:", error);
            teacherBody.innerHTML = `<div class="alert alert-danger" role="alert">Xatolik sodir boldi</div>`;
          });
      };

      const openEditModal = (id) => {
        lastId = id;
        editmodal.show();
        axios
          .get(`https://a6d284e69c9e5cfd.mokky.dev/students/${id}`)
          .then((response) => {
            const student = response.data;
            document.querySelector("#name1").value = student.name;
            document.querySelector("#lastName1").value = student.lastName;
            document.querySelector("#class1").value = student.class;
            document.querySelector("#gender1").value = student.gender;
            document.querySelector("#photo1").value = student.studentFoto;
          })
          .catch((error) => {
            console.log(error);
          });
      };

      function edit2button() {
        const data = {
          name: document.querySelector("#name1").value,
          lastName: document.querySelector("#lastName1").value,
          class: document.querySelector("#class1").value,
          gender: document.querySelector("#gender1").value,
          studentFoto: document.querySelector("#photo1").value,
        };
        axios
          .patch(`https://a6d284e69c9e5cfd.mokky.dev/students/${lastId}`, data)
          .then((responsel) => {
            Toastify({
              text: "O'zgartirildi",
              duration: 2000,
            }).showToast();
            editmodal.hide();
            main();
          })
          .catch((error) => {
            console.error("Xatolik:", error);
          });
      }

      search.addEventListener("input", async (e) => {
        try {
          const searchResult = await axios.get(
            "https://a6d284e69c9e5cfd.mokky.dev/students/"
          );

          const eventSearch = e.target.value.toLowerCase();

          const filteredSearch = searchResult.data.filter((item) =>
            item.name.toLowerCase().includes(eventSearch)
          );

          studentsTableBody.innerHTML = "";

          filteredSearch.forEach((item, index) => {
            studentsTableBody.innerHTML += ` <tr>
                <td>${index + 1}</td>
                <td><img src="${
                  item.studentFoto
                }" width="40" height="40" class="object-fit-cover rounded"></td>
                <td>${item.name || ""} ${item.lastName || ""}</td>
                <td>${item.class}</td>
                <td>
                  <div class="dropdown">
                    <button class=" border-0 bg-transparent" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="#" onclick="showStudentInfo(${
                        item.id
                      })">Info</a></li>
                      <li><a class="dropdown-item" href="#">Class</a></li>
                      <li><a class="dropdown-item" href="#" onclick="openTeacherModal()">Teacher</a></li>
                      <li><a class="dropdown-item" href="#" onclick="openEditModal(${
                        item.id
                      })">Edit</a></li>
                      <li><a class="dropdown-item" href="#" onclick="removeStudent(${
                        item.id
                      })">Remove</a></li>
                    </ul>
                  </div>
                </td>
              </tr>
            `;
          });
        } catch (error) {
          console.log(error);
        }
      });
    </script>
  </body>
</html>
